name: recheck

on:
  issue_comment:
    types: [created]

permissions:
  actions: write
  contents: read
  pull-requests: read

jobs:
  recheck:
    if: >
      github.event.issue.pull_request &&
      contains(toLower(github.event.comment.body), 'recheck')

    runs-on: ubuntu-latest
    steps:
      - name: Trigger main CI workflow again
        uses: actions/github-script@v7
        with:
          script: |
            const allowed = ['MEMBER','OWNER','COLLABORATOR'];
            const assoc = context.payload.comment.author_association;
            if (!allowed.includes(assoc)) {
              core.setFailed(`Not allowed: ${assoc}`);
              return;
            }

            const prNumber = context.payload.issue.number;
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            const ref = pr.data.head.ref;

            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'main.yml',
              ref: ref,
            });
