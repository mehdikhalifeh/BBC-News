name: recheck

on:
  issue_comment:
    types: [created]

permissions:
  actions: write
  contents: read
  pull-requests: read
  issues: write

jobs:
  recheck:
    if: ${{ github.event.issue.pull_request }}
    runs-on: ubuntu-latest

    steps:
      - name: Handle recheck command
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const body = (context.payload.comment.body || '').trim().toLowerCase();

            // ÙÙ‚Ø· ÙˆÙ‚ØªÛŒ Ú©Ø§Ø± Ú©Ù† Ú©Ù‡ Ø¯Ù‚ÛŒÙ‚Ø§ "recheck" (ÛŒØ§ /recheck) ØªØ§ÛŒÙ¾ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ù‡
            if (!(body === 'recheck' || body === '/recheck')) {
              core.info('No recheck command, exiting');
              return;
            }

            const allowed = ['MEMBER','OWNER','COLLABORATOR','CONTRIBUTOR'];
            const assoc = context.payload.comment.author_association;

            if (!allowed.includes(assoc)) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                body: `âŒ Not allowed to run recheck (author_association=${assoc}).`
              });
              core.setFailed(`Not allowed: ${assoc}`);
              return;
            }

            const prNumber = context.payload.issue.number;

            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            const ref = pr.data.head.ref;

            // Ø§ÙˆÙ„ Ú©Ø§Ù…Ù†Øª Ø¨Ø¯Ù‡ Ú©Ù‡ ÙÙ‡Ù…ÛŒØ¯ÛŒÙ…
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `ğŸ”„ Recheck received. Re-triggering **main.yml** on branch \`${ref}\`...`
            });

            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'main.yml',
                ref: ref,
              });

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `âœ… Dispatched **main.yml** on \`${ref}\`.`
              });

              core.info('Dispatch OK');
            } catch (e) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `âŒ Dispatch failed: ${e.message}`
              });
              core.setFailed(`Dispatch failed: ${e.message}`);
            }
