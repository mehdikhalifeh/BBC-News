name: recheck

on:
  issue_comment:
    types: [created]

permissions:
  actions: write
  contents: read
  pull-requests: read

jobs:
  recheck:
    if: ${{ github.event.issue.pull_request }}
    runs-on: ubuntu-latest

    steps:
      - name: Trigger main workflow again
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const body = context.payload.comment.body.toLowerCase();

            if (!body.includes('recheck')) {
              core.info('No recheck command found');
              return;
            }

            const allowed = ['MEMBER','OWNER','COLLABORATOR','CONTRIBUTOR'];
            const assoc = context.payload.comment.author_association;

            if (!allowed.includes(assoc)) {
              core.setFailed(`Not allowed: ${assoc}`);
              return;
            }

            const prNumber = context.payload.issue.number;

            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            const ref = pr.data.head.ref;

            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'main.yml',
              ref: ref,
            });

            core.info(`main.yml re-triggered on ${ref}`);
